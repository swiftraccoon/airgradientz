{
  "responseShapes": {
    "reading": {
      "requiredFields": [
        "id", "timestamp", "device_id", "device_type", "device_ip",
        "pm01", "pm02", "pm10", "pm02_compensated",
        "rco2", "atmp", "atmp_compensated", "rhum", "rhum_compensated",
        "tvoc_index", "nox_index", "wifi"
      ],
      "forbiddenFields": ["raw_json"]
    },
    "readingDownsampled": {
      "requiredFields": [
        "timestamp", "device_id", "device_type", "device_ip",
        "pm01", "pm02", "pm10", "pm02_compensated",
        "rco2", "atmp", "atmp_compensated", "rhum", "rhum_compensated",
        "tvoc_index", "nox_index", "wifi"
      ],
      "forbiddenFields": ["raw_json", "id"]
    },
    "device": {
      "requiredFields": [
        "device_id", "device_type", "device_ip", "last_seen", "reading_count"
      ],
      "forbiddenFields": ["first_seen"]
    },
    "count": {
      "exactFields": ["count"],
      "noExtraFields": true
    },
    "config": {
      "requiredFields": ["pollIntervalMs", "downsampleBuckets", "devices"],
      "forbiddenFields": ["downsampleThreshold"]
    },
    "health": {
      "requiredFields": [
        "ip", "label", "status", "lastSuccess", "lastError",
        "lastErrorMessage", "consecutiveFailures"
      ]
    },
    "error": {
      "exactFields": ["error"],
      "noExtraFields": true
    },
    "stats": {
      "requiredFields": [
        "implementation", "pid", "uptime_ms", "memory_rss_bytes",
        "db_size_bytes", "readings_count", "requests_served",
        "active_connections", "poll_successes", "poll_failures",
        "pool_alloc_count", "pool_bytes_used", "started_at"
      ]
    }
  },
  "queryEdgeCases": [
    {
      "name": "limit=0 means no explicit limit",
      "endpoint": "/api/readings",
      "params": {"limit": "0"},
      "expect": {"statusCode": 200, "resultCapped": "maxApiRows"}
    },
    {
      "name": "negative limit treated as no limit",
      "endpoint": "/api/readings",
      "params": {"limit": "-5"},
      "expect": {"statusCode": 200, "resultCapped": "maxApiRows"}
    },
    {
      "name": "limit exceeding maxApiRows is capped",
      "endpoint": "/api/readings",
      "params": {"limit": "999999999"},
      "expect": {"statusCode": 200, "resultCapped": "maxApiRows"}
    },
    {
      "name": "limit=1 returns exactly 1",
      "endpoint": "/api/readings",
      "params": {"limit": "1"},
      "expect": {"statusCode": 200, "resultCount": 1}
    },
    {
      "name": "from > to returns empty array",
      "endpoint": "/api/readings",
      "params": {"from": "9999999999999", "to": "1"},
      "expect": {"statusCode": 200, "body": []}
    },
    {
      "name": "missing device param returns all",
      "endpoint": "/api/readings",
      "params": {},
      "expect": {"statusCode": 200, "hasResults": true}
    },
    {
      "name": "device=all returns all",
      "endpoint": "/api/readings",
      "params": {"device": "all"},
      "expect": {"statusCode": 200, "hasResults": true}
    },
    {
      "name": "empty device param returns all",
      "endpoint": "/api/readings",
      "params": {"device": ""},
      "expect": {"statusCode": 200, "hasResults": true}
    },
    {
      "name": "nonexistent device returns empty",
      "endpoint": "/api/readings",
      "params": {"device": "nonexistent-serial-xyz"},
      "expect": {"statusCode": 200, "body": []}
    },
    {
      "name": "invalid downsample returns 400",
      "endpoint": "/api/readings",
      "params": {"downsample": "2h"},
      "expect": {"statusCode": 400, "bodyHasKey": "error"}
    },
    {
      "name": "count with from > to returns zero",
      "endpoint": "/api/readings/count",
      "params": {"from": "9999999999999", "to": "1"},
      "expect": {"statusCode": 200, "body": {"count": 0}}
    },
    {
      "name": "count with nonexistent device returns zero",
      "endpoint": "/api/readings/count",
      "params": {"device": "nonexistent-serial-xyz"},
      "expect": {"statusCode": 200, "body": {"count": 0}}
    }
  ],
  "downsampleBuckets": [
    {"param": "5m",  "expectMs": 300000},
    {"param": "10m", "expectMs": 600000},
    {"param": "15m", "expectMs": 900000},
    {"param": "30m", "expectMs": 1800000},
    {"param": "1h",  "expectMs": 3600000},
    {"param": "1d",  "expectMs": 86400000},
    {"param": "1w",  "expectMs": 604800000}
  ],
  "securityCases": [
    {
      "name": "path traversal blocked",
      "method": "GET",
      "path": "/../../../etc/passwd",
      "expect": {"statusCode": 403}
    },
    {
      "name": "encoded path traversal blocked",
      "method": "GET",
      "path": "/%2e%2e/%2e%2e/etc/passwd",
      "expect": {"statusCode": 403}
    },
    {
      "name": "NUL byte in path blocked",
      "method": "GET",
      "path": "/app.js%00.html",
      "expect": {"statusCode": 400}
    },
    {
      "name": "POST on readings returns 405",
      "method": "POST",
      "path": "/api/readings",
      "expect": {"statusCode": 405}
    },
    {
      "name": "unknown API path returns 404",
      "method": "GET",
      "path": "/api/nonexistent",
      "expect": {"statusCode": 404}
    }
  ],
  "httpTests": [
    {"name":"GET /api/readings/latest returns 200 with correct shape","method":"GET","path":"/api/readings/latest","expect":{"status":200,"headers":{"Content-Type":"application/json"},"bodyShape":"reading","bodyHasResults":true}},
    {"name":"GET /api/devices returns 200 with correct shape","method":"GET","path":"/api/devices","expect":{"status":200,"headers":{"Content-Type":"application/json"},"bodyShape":"device","bodyHasResults":true}},
    {"name":"GET /api/health returns 200 with correct shape","method":"GET","path":"/api/health","expect":{"status":200,"headers":{"Content-Type":"application/json"},"bodyShape":"health","bodyHasResults":true}},
    {"name":"GET /api/config returns 200 with correct shape","method":"GET","path":"/api/config","expect":{"status":200,"headers":{"Content-Type":"application/json"},"bodyShape":"config"}},
    {"name":"GET /api/stats returns 200 with correct shape","method":"GET","path":"/api/stats","expect":{"status":200,"headers":{"Content-Type":"application/json"},"bodyShape":"stats"}},
    {"name":"GET /api/readings returns 200 with correct shape","method":"GET","path":"/api/readings?from=0&to=9999999999999","expect":{"status":200,"headers":{"Content-Type":"application/json"},"bodyShape":"reading","bodyHasResults":true}},
    {"name":"GET /api/readings/count returns 200 with correct shape","method":"GET","path":"/api/readings/count?from=0&to=9999999999999","expect":{"status":200,"headers":{"Content-Type":"application/json"},"bodyShape":"count"}},

    {"name":"Content-Type: text/html for /","method":"GET","path":"/","expect":{"status":200,"headers":{"Content-Type":"text/html"}}},
    {"name":"Content-Type: text/css for /style.css","method":"GET","path":"/style.css","expect":{"status":200,"headers":{"Content-Type":"text/css"}}},
    {"name":"Content-Type: application/javascript for /app.js","method":"GET","path":"/app.js","expect":{"status":200,"headers":{"Content-Type":"application/javascript"}}},
    {"name":"X-Content-Type-Options: nosniff on API","method":"GET","path":"/api/config","expect":{"status":200,"headers":{"X-Content-Type-Options":"nosniff"}}},
    {"name":"X-Content-Type-Options: nosniff on static","method":"GET","path":"/","expect":{"status":200,"headers":{"X-Content-Type-Options":"nosniff"}}},
    {"name":"X-Frame-Options: DENY on API","method":"GET","path":"/api/config","expect":{"status":200,"headers":{"X-Frame-Options":"DENY"}}},
    {"name":"X-Frame-Options: DENY on static","method":"GET","path":"/","expect":{"status":200,"headers":{"X-Frame-Options":"DENY"}}},
    {"name":"No X-Powered-By on API","method":"GET","path":"/api/config","expect":{"status":200,"headersAbsent":["X-Powered-By"]}},
    {"name":"No X-Powered-By on static","method":"GET","path":"/","expect":{"status":200,"headersAbsent":["X-Powered-By"]}},
    {"name":"Cache-Control present on /style.css","method":"GET","path":"/style.css","expect":{"status":200,"headers":{"Cache-Control":""}}},
    {"name":"Cache-Control present on /app.js","method":"GET","path":"/app.js","expect":{"status":200,"headers":{"Cache-Control":""}}},
    {"name":"Content-Type: application/json for /api/readings","method":"GET","path":"/api/readings?from=0&to=9999999999999","expect":{"status":200,"headers":{"Content-Type":"application/json"}}},

    {"name":"readings have no raw_json field","method":"GET","path":"/api/readings?from=0&to=9999999999999","expect":{"status":200,"bodyFieldAbsent":"raw_json"}},
    {"name":"downsampled readings have correct shape","method":"GET","path":"/api/readings?from=0&to=9999999999999&downsample=1h","expect":{"status":200,"bodyShape":"readingDownsampled"}},
    {"name":"downsampled readings omit id","method":"GET","path":"/api/readings?from=0&to=9999999999999&downsample=1h","expect":{"status":200,"noIdField":true}},
    {"name":"devices have no first_seen field","method":"GET","path":"/api/devices","expect":{"status":200,"bodyFieldAbsent":"first_seen"}},
    {"name":"error response shape (400)","method":"GET","path":"/api/readings?downsample=bogus","expect":{"status":400,"bodyShape":"error"}},
    {"name":"error response shape (404)","method":"GET","path":"/api/nonexistent","expect":{"status":404,"bodyShape":"error"}},
    {"name":"error response shape (405)","method":"POST","path":"/api/readings","expect":{"status":405,"bodyShape":"error"}},

    {"name":"limit=0 returns data (no explicit limit)","method":"GET","path":"/api/readings?from=0&to=9999999999999&limit=0","expect":{"status":200,"bodyHasResults":true}},
    {"name":"limit=-5 returns data (negative treated as no limit)","method":"GET","path":"/api/readings?from=0&to=9999999999999&limit=-5","expect":{"status":200,"bodyHasResults":true}},
    {"name":"limit=999999999 returns data (capped by maxApiRows)","method":"GET","path":"/api/readings?from=0&to=9999999999999&limit=999999999","expect":{"status":200,"bodyHasResults":true}},
    {"name":"limit=1 returns exactly 1 result","method":"GET","path":"/api/readings?from=0&to=9999999999999&limit=1","expect":{"status":200,"bodyHasResults":true,"bodyLength":1}},
    {"name":"from > to returns empty array","method":"GET","path":"/api/readings?from=9999999999999&to=1","expect":{"status":200,"bodyIsEmptyArray":true}},
    {"name":"missing device param returns results","method":"GET","path":"/api/readings?from=0&to=9999999999999","expect":{"status":200,"bodyHasResults":true}},
    {"name":"device=all returns results","method":"GET","path":"/api/readings?from=0&to=9999999999999&device=all","expect":{"status":200,"bodyHasResults":true}},
    {"name":"empty device param returns results","method":"GET","path":"/api/readings?from=0&to=9999999999999&device=","expect":{"status":200,"bodyHasResults":true}},
    {"name":"nonexistent device returns empty array","method":"GET","path":"/api/readings?from=0&to=9999999999999&device=nonexistent-serial-xyz","expect":{"status":200,"bodyIsEmptyArray":true}},
    {"name":"invalid downsample returns 400","method":"GET","path":"/api/readings?downsample=2h","expect":{"status":400}},
    {"name":"count from > to returns zero","method":"GET","path":"/api/readings/count?from=9999999999999&to=1","expect":{"status":200,"bodyExact":{"count":0}}},
    {"name":"count nonexistent device returns zero","method":"GET","path":"/api/readings/count?from=0&to=9999999999999&device=nonexistent-serial-xyz","expect":{"status":200,"bodyExact":{"count":0}}},

    {"name":"downsample=5m returns 200","method":"GET","path":"/api/readings?from=0&to=9999999999999&downsample=5m","expect":{"status":200}},
    {"name":"downsample=10m returns 200","method":"GET","path":"/api/readings?from=0&to=9999999999999&downsample=10m","expect":{"status":200}},
    {"name":"downsample=15m returns 200","method":"GET","path":"/api/readings?from=0&to=9999999999999&downsample=15m","expect":{"status":200}},
    {"name":"downsample=30m returns 200","method":"GET","path":"/api/readings?from=0&to=9999999999999&downsample=30m","expect":{"status":200}},
    {"name":"downsample=1h returns 200","method":"GET","path":"/api/readings?from=0&to=9999999999999&downsample=1h","expect":{"status":200}},
    {"name":"downsample=1d returns 200","method":"GET","path":"/api/readings?from=0&to=9999999999999&downsample=1d","expect":{"status":200}},
    {"name":"downsample=1w returns 200","method":"GET","path":"/api/readings?from=0&to=9999999999999&downsample=1w","expect":{"status":200}},
    {"name":"downsample with device filter returns 200","method":"GET","path":"/api/readings?from=0&to=9999999999999&downsample=1h&device=indoor","expect":{"status":200}},
    {"name":"downsample empty time range returns empty","method":"GET","path":"/api/readings?from=9999999999999&to=9999999999999&downsample=1h","expect":{"status":200,"bodyIsEmptyArray":true}},

    {"name":"path traversal blocked (raw)","method":"GET","path":"/../../../etc/passwd","expect":{"status":403}},
    {"name":"path traversal blocked (encoded)","method":"GET","path":"/%2e%2e/%2e%2e/etc/passwd","expect":{"status":403}},
    {"name":"NUL byte in path blocked","method":"GET","path":"/app.js%00.html","expect":{"status":400}},
    {"name":"POST /api/readings returns 405","method":"POST","path":"/api/readings","expect":{"status":405}},
    {"name":"DELETE /api/readings returns 405","method":"DELETE","path":"/api/readings","expect":{"status":405}},
    {"name":"PUT /api/readings returns 405","method":"PUT","path":"/api/readings","expect":{"status":405}},
    {"name":"unknown API path returns 404","method":"GET","path":"/api/nonexistent","expect":{"status":404}},

    {"name":"GET / returns HTML with dashboard title","method":"GET","path":"/","expect":{"status":200,"bodyContains":"AirGradient Dashboard"}},
    {"name":"GET /style.css returns CSS","method":"GET","path":"/style.css","expect":{"status":200,"bodyContains":"box-sizing"}},
    {"name":"GET /app.js returns JS","method":"GET","path":"/app.js","expect":{"status":200,"bodyContains":"fetchReadings"}},
    {"name":"HTML has charts section","method":"GET","path":"/","expect":{"status":200,"bodyContains":"id=\"charts\""}},
    {"name":"HTML has device-status","method":"GET","path":"/","expect":{"status":200,"bodyContains":"id=\"device-status\""}},
    {"name":"HTML has time-range nav","method":"GET","path":"/","expect":{"status":200,"bodyContains":"id=\"time-range\""}},
    {"name":"HTML has current-values","method":"GET","path":"/","expect":{"status":200,"bodyContains":"id=\"current-values\""}},
    {"name":"CSS has .chart-card class","method":"GET","path":"/style.css","expect":{"status":200,"bodyContains":".chart-card"}},
    {"name":"JS references /api/readings","method":"GET","path":"/app.js","expect":{"status":200,"bodyContains":"/api/readings"}},

    {"name":"readings sorted by timestamp ASC","method":"GET","path":"/api/readings?from=0&to=9999999999999","expect":{"status":200,"arraySortedAsc":"timestamp"}}
  ]
}
